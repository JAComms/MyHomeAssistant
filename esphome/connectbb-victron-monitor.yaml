#########################################################################
#
# Environmental monitoring using Kincony S3 Core board with JAComms HAT
# to monitor remote WISP sites with Victron battery configuration
#
   # Dallas Temp ID: 0x4f0b2374ee7fa928

##########################################################################
# VERSION UPATES:
#
# v1.0.0 - xx-May-2025 - Initial Release
#

   # Provides substitutions or variables that are then called elsewhere multiple times in the config
substitutions:
  # Default name  
  name: "victron-monitor-s3-core"
  # Default friendly name 
  friendly_name: "Victron Monitor - JAComms S3 Core"
  # Description as appears in ESPHome & top of webserver page
  device_description: "WISP Site - Remote Monitoring"
  # Allows ESP device to be automatically lined to an 'Area' in Home Assistant. Enter the remote stations site name here.
  location: "Site-name"
  # Location geographical height, in meters. Used for calculations in sensors such as BME280/BME680 and Water Tank sensors. Goulburn (673)
  location_height: "673"
  # Project Name
  project_name: "JAComms.Victron Monitor"
  # Project version denotes the release version of the yaml file, allowing checking of deployed vs latest version
  project_version: "0.1.1"
  # The phase in the locations power supply, upon which this device is utilsed. 1p = A. 3p = A, B or C.  (GPO 1 = Phase A, GPO 2 = Phase B, GPO 3 = Phase C).
  # Used to populate a Text Sensor with this information, that may be used to loadshed in future, or trace outages to electrical faults.
  power_circuit: "TBA"
  # Define logging level: NONE, ERROR, WARN, INFO, DEBUG (Default), VERBOSE, VERY_VERBOSE.
  # Use 'INFO' as at DEBUG the energy/water/gas statistics "Internal" sensors appear in the logs
  log_level: "DEBUG"


  # BME 280 / BME680 Sensor
  # Location of BME280/680 Sensor #1. Used to prefix sensor if there are two. Leave empty if only 1. Add a " - " to the end of each entry if used.
  bme_sensor1_location: ""
  # Location of BME280/680 Sensor #2. Used to prefix sensor if there are two. Leave empty if only 1. Add a " - " to the end of each entry if used.
  bme_sensor2_location: ""
  # Calibrate the outpute of the temperature sensor(s).
  temperature_1_offset: "0.0"
  temperature_2_offset: "0.0"
  # Calibrate the outpute of the pressure sensor(s).
  pressure_1_offset: "0.0"
  pressure_2_offset: "0.0"
  # Calibrate the outpute of the humidity sensor(s).
  humidity_1_offset: "0.0"
  humidity_2_offset: "0.0"


   # Enable logs to DEBUG and determine the ds18b20 address and paste below
#  ds18b20_address: "0x4f0b2374ee7fa928"
   # ds18b20 Sensor
   # Location of ds18b20 Sensor. Used to prefix sensor if there are two. Leave empty if only 1. Add a " - " to the end of each entry if used.
  ds18b20_sensor_location: ""
   # Calibrate the outpute of the temperature sensor(s).
  ds18b20_temperature_offset: "0.0"


########################## End of Substitutions #########################
#
# Remote Packages to be utilised
#

dashboard_import:
  package_import_url: github://jacomms/myhomeassistant/esphome/connectbb-victron-monitor.yaml@main
  import_full_config: false

packages:
  base-config:             !include common/base-configuration.yaml              # Base configuration applied to all ESPHome devices
  network-config:          !include common/network-ethernet-w5500.yaml          # Configure Ethernet port on this system board
  webserver-groups:        !include common/webserver-groups.yaml                # Central file consolidating the web server groups and their sort orders
  bme280a-sensors:         !include sensors/bme280-bus-a.yaml                   # Temperature, Humidity, Pressure sensor probe
  dallas-temp-sensors:     !include sensors/ds18b20-1wire.yaml                  # One Wire / Dallas Temp Probe Sensors
  esp32-system-board:      !include boards/kincony-esp32-s3-core.yaml           # Model of ESP Board being used. This is Kincony S3 Core with JAComms add-on HAT board.

#########################################################################
#
# Custom Components to be utilised - For Gas and Water Statistics
#

external_components:
  # Load energy sensors for time period based kWh consumption reporting
  - source:
      type: git
      url: https://github.com/jacomms/myhomeassistant/
      ref: main
    refresh: 0s
    components: [ energy_statistics ]

  # Load Victron MPPT sensors
  - source:
      type: git
      url: https://github.com/KinDR007/VictronMPPT-ESPHOME
      ref: main
    refresh: 0s
    components: [ victron ]

#########################################################################
#
# Web_server v3 Sort Groups - These substitutes are applied to overwrite the default ones supplied by the 
# sensor specific template file, in this case the /sensors/hc-sr04-ultrasonic.yaml file.
#

#web_server:
#  sorting_groups:

#     name: "Environmental Sensors"
#     sorting_weight: -45  
      
      # This sort group is used .................
#    - id: group_victron_smartshunt_sensors
#      name: "Victron - Smartshunt Sensors"
#      sorting_weight: 1

      # This sort group is used .................
 #   - id: group_victron_solar_sensors
 #     name: "Victron - Solar Sensors"
 #     sorting_weight: 5

      # This sort group is used .................
#    - id: group_victron_alarm_sensors
#      name: "Victron - Alarms Sensors"
#      sorting_weight: 10


#########################################################################
#
# Serial / COMs Port and Map VICTRON to use UART 0 and 1.
#

uart:
  - id: uart_0
    tx_pin: GPIO10
    rx_pin: GPIO11
    baud_rate: 19200
    rx_buffer_size: 256
  
  - id: uart_1
    tx_pin: GPIO12  
    rx_pin: GPIO13
    baud_rate: 19200
    rx_buffer_size: 256

victron:
  - id: victron0
    uart_id: uart_0
    throttle: 10s
  
  - id: victron1
    uart_id: uart_1
    throttle: 10s
    

##########################################################################
#
# Sensors
#

sensor:
  - platform: victron
    victron_id: victron0

    battery_voltage:
      name: "SmartShunt - battery voltage"

    auxiliary_battery_voltage:
      name: "SmartShunt - auxiliary battery voltage"

    midpoint_voltage_of_the_battery_bank:
      name: "SmartShunt - midpoint voltage of the battery bank"

    midpoint_deviation_of_the_battery_bank:
      name: "SmartShunt - midpoint deviation of the battery bank"

    battery_current:
      name: "SmartShunt - battery current"

    battery_temperature:
      name: "SmartShunt - battery temperature"

    instantaneous_power:
      name: "SmartShunt - instantaneous power"

    consumed_amp_hours:
      name: "SmartShunt - consumed amp hours"

    state_of_charge:
      name: "SmartShunt - state of charge"

    time_to_go:
      name: "SmartShunt - time to go"

    depth_of_the_deepest_discharge:
      name: "SmartShunt - depth of the deepest discharge"

    depth_of_the_last_discharge:
      name: "SmartShunt - depth of the last discharge"

    depth_of_the_average_discharge:
      name: "SmartShunt - depth of the average discharge"

    number_of_charge_cycles:
      name: "SmartShunt - number of charge cycles"

    number_of_full_discharges:
      name: "SmartShunt - number of full discharges"
    
    cumulative_amp_hours_drawn:
      name: "SmartShunt - cumulative amp hours drawn"
    
    min_battery_voltage:
      name: "SmartShunt - min battery voltage"
    
    max_battery_voltage:
      name: "SmartShunt - max battery voltage"
    
    last_full_charge:
      name: "SmartShunt - last full charge"
    
    number_of_automatic_synchronizations:
      name: "SmartShunt - number of automatic synchronizations"
    
    number_of_low_main_voltage_alarms:
      name: "SmartShunt - number of low main voltage alarms"
    
    number_of_high_main_voltage_alarms:
      name: "SmartShunt - number of high main voltage alarms"
    
    number_of_low_auxiliary_voltage_alarms:
      name: "SmartShunt - number of low auxiliary voltage alarms"
    
    number_of_high_auxiliary_voltage_alarms:
      name: "SmartShunt - number of high auxiliary voltage alarms"
    
    min_auxiliary_battery_voltage:
      name: "SmartShunt - min auxiliary battery voltage"
    
    max_auxiliary_battery_voltage:
      name: "SmartShunt - max auxiliary battery voltage"
    
    amount_of_discharged_energy:
      name: "SmartShunt - amount of discharged energy"
    
    amount_of_charged_energy:
      name: "SmartShunt - amount of charged energy"
    
    dc_monitor_mode_id:
      name: "SmartShunt - dc monitor mode id"

  ##########################################################################
  
  - platform: victron
    victron_id: victron1
  
    max_power_yesterday:
      name: "SmartSolar - max power yesterday"
    
    max_power_today:
      name: "SmartSolar - max power today"
    
    yield_total:
      name: "SmartSolar - yield total"
    
    yield_yesterday:
      name: "SmartSolar - yield yesterday"
    
    yield_today:
      name: "SmartSolar - yield today"
    
    panel_voltage:
      name: "SmartSolar - panel voltage"
    
    panel_power:
      name: "SmartSolar - panel power"
    
    battery_current:
      name: "SmartSolar - panel current"
    
    battery_voltage:
      name: "SmartSolar - battery voltage"
    
    day_number:
      name: "SmartSolar - day number"
    
    charging_mode_id:
      name: "SmartSolar - charging mode id"
    
    error_code:
      name: "SmartSolar - error code"
    
    tracking_mode_id:
      name: "SmartSolar - tracking mode id"
    
    load_current:
      name: "SmartSolar - load current"

##########################################################################

text_sensor:
  - platform: victron
    victron_id: victron0

    alarm_condition_active:
      name: "SmartShunt - alarm condition active"

    alarm_reason:
      name: "SmartShunt - alarm reason"
    
    model_description:
      name: "SmartShunt - model description"
    
    firmware_version:
      name: "SmartShunt - firmware version"
    
    device_type:
      name: "SmartShunt - device type"
    
    serial_number:
      name: "SmartShunt -serial number"
    
    dc_monitor_mode:
      name: "SmartShunt - dc monitor mode"

##########################################################################

  - platform: victron
    victron_id: victron1		

    charging_mode:
      name: "SmartSolar - charging mode"
    
    error:
      name: "SmartSolar - error"
    
    tracking_mode:
      name: "SmartSolar - tracking mode"
    
    firmware_version:
      name: "SmartSolar - firmware version"
    
    device_type:
      name: "SmartSolar - device type"
    
    serial_number:
      name: "SmartSolar - serial number"

##########################################################################
